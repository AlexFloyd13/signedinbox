name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  check:
    name: Type check & build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: TypeScript type check
        run: npx tsc --noEmit

      - name: Build
        run: npm run build
        env:
          # Minimal env for build â€” no real secrets needed for type checking
          NEXT_PUBLIC_SUPABASE_URL: https://placeholder.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: placeholder
          SUPABASE_URL: https://placeholder.supabase.co
          SUPABASE_SERVICE_KEY: placeholder
          ENCRYPTION_KEY: 0000000000000000000000000000000000000000000000000000000000000000
          API_KEY_HASH_SECRET: 0000000000000000000000000000000000000000000000000000000000000000
          NEXT_PUBLIC_TURNSTILE_SITE_KEY: 1x00000000000000000000AA
          TURNSTILE_SECRET_KEY: 1x0000000000000000000000000000000AA
          NEXT_PUBLIC_SITE_URL: https://example.com
          TURNSTILE_DEV_BYPASS: "true"

  extension:
    name: Extension build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: extension/package-lock.json

      - name: Install extension dependencies
        working-directory: extension
        run: npm ci

      - name: Build extension
        working-directory: extension
        run: npm run build
        env:
          SUPABASE_URL: https://placeholder.supabase.co
          SUPABASE_ANON_KEY: placeholder
          TURNSTILE_SITE_KEY: 1x00000000000000000000AA
          SITE_URL: https://example.com
